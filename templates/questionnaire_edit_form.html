{% extends "base.html" %}

{% block title %}Editar Cuestionario{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Editar Cuestionario</h2>
    <a href="{% url 'dashboard-page' %}" class="btn btn-secondary">Cancelar</a>
</div>

<form id="edit-questionnaire-form">
    <div class="card mb-4">
        <div class="card-body">
            <div class="mb-3">
                <label for="questionnaire-title" class="form-label fw-bold">Título del Cuestionario</label>
                <input type="text" class="form-control" id="questionnaire-title" required>
            </div>
        </div>
    </div>
    
    <div id="questions-container">
        <p>Cargando preguntas existentes...</p>
    </div>

    <button type="button" id="add-question-btn" class="btn btn-outline-primary mb-3">Añadir Pregunta</button>
    <hr>
    <div id="error-message" class="alert alert-danger d-none"></div>
    <button type="submit" class="btn btn-success w-100">Guardar Cambios</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('authToken');
    const questionnaireId = {{ questionnaire_id }};
    if (!token) {
        window.location.href = '/login/';
        return;
    }

    const titleInput = document.getElementById('questionnaire-title');
    const questionsContainer = document.getElementById('questions-container');
    const addQuestionBtn = document.getElementById('add-question-btn');
    const form = document.getElementById('edit-questionnaire-form');
    const errorMessage = document.getElementById('error-message');
    let questionCounter = 0;

    // --- Lógica para añadir elementos dinámicamente ---
    function addQuestion(question = { id: null, text: '', options: [] }) {
        questionCounter++;
        const questionDiv = document.createElement('div');
        questionDiv.className = 'card mb-3 question-card';
        // Guardamos el ID de la pregunta si ya existe
        questionDiv.dataset.questionId = question.id || '';
        questionDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <label class="form-label fw-bold">Pregunta</label>
                    <button type="button" class="btn-close remove-question-btn"></button>
                </div>
                <input type="text" class="form-control question-text" value="${question.text}" required>
                <div class="options-container mt-2 ps-4"></div>
                <button type="button" class="btn btn-outline-secondary btn-sm mt-2 add-option-btn">Añadir Opción</button>
            </div>
        `;
        const optionsContainer = questionDiv.querySelector('.options-container');
        question.options.forEach(opt => addOption(optionsContainer, opt));
        questionsContainer.appendChild(questionDiv);
    }

    function addOption(container, option = { id: null, text: '' }) {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'input-group input-group-sm mb-2';
        // Guardamos el ID de la opción si ya existe
        optionDiv.dataset.optionId = option.id || '';
        optionDiv.innerHTML = `
            <span class="input-group-text">Opción:</span>
            <input type="text" class="form-control option-text" value="${option.text}" required>
            <button class="btn btn-outline-danger remove-option-btn" type="button">X</button>
        `;
        container.appendChild(optionDiv);
    }

    // --- Cargar los datos existentes ---
    fetch(`/api/questionnaires/${questionnaireId}/`, { headers: { 'Authorization': `Token ${token}` }})
        .then(res => res.json())
        .then(data => {
            titleInput.value = data.title;
            questionsContainer.innerHTML = ''; // Limpiar "cargando..."
            data.questions.forEach(q => addQuestion(q));
            questionCounter = data.questions.length;
        });

    addQuestionBtn.addEventListener('click', () => addQuestion());

    questionsContainer.addEventListener('click', function(event) {
        if (event.target.classList.contains('add-option-btn')) {
            addOption(event.target.previousElementSibling);
        }
        if (event.target.classList.contains('remove-option-btn')) { event.target.closest('.input-group').remove(); }
        if (event.target.classList.contains('remove-question-btn')) { event.target.closest('.card').remove(); }
    });

    // --- Manejar el envío del formulario ---
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        errorMessage.classList.add('d-none');

        const payload = {
            title: titleInput.value,
            questions: []
        };

        document.querySelectorAll('.question-card').forEach(card => {
            const questionData = {
                id: card.dataset.questionId ? parseInt(card.dataset.questionId) : null,
                text: card.querySelector('.question-text').value,
                options: []
            };
            card.querySelectorAll('.input-group').forEach(optDiv => {
                questionData.options.push({
                    id: optDiv.dataset.optionId ? parseInt(optDiv.dataset.optionId) : null,
                    text: optDiv.querySelector('.option-text').value
                });
            });
            payload.questions.push(questionData);
        });

        fetch(`/api/questionnaires/${questionnaireId}/`, {
            method: 'PUT', // Usamos PUT para una actualización completa
            headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` },
            body: JSON.stringify(payload)
        })
        .then(response => {
            if (!response.ok) { return response.json().then(err => { throw err; }); }
            return response.json();
        })
        .then(data => {
            alert('¡Cuestionario actualizado con éxito!');
            window.location.href = '/dashboard/';
        })
        .catch(error => {
            console.error('Error al actualizar:', error);
            errorMessage.textContent = 'Ocurrió un error. Asegúrate de que todos los campos tengan texto.';
            errorMessage.classList.remove('d-none');
        });
    });
});
</script>
{% endblock %}