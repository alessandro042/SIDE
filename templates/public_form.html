{% extends "base_public_form.html" %}

{% block title %}Contestar Cuestionario{% endblock %}

{% block content %}
<style>
    /* Paleta de colores y estilos base (Sin cambios) */
    :root {
        --main-bg-light: #F8FAFD;
        --panel-right-bg: #F4F7FB;
        --oracle-red-accent: #A83C3C;
        --oracle-red-hover: #8B2F2F;
        --text-dark-blue-grey: #333F4F;
        --text-medium-grey: #6C7A89;
        --border-light-grey: #DDE2E7;
        --neutral-white: #FFFFFF;
        --success-text: #66BB6A;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--main-bg-light);
    }
    
    /* --- Contenedor Principal (Ajustes menores) --- */
    .survey-main-container {
        max-width: 900px; /* Un poco más angosto para mejor legibilidad */
        margin: 40px auto;
        padding: 0;
        background-color: transparent; /* El fondo lo darán las tarjetas */
        box-shadow: none;
        border-radius: 15px;
    }

    /* --- Encabezado del Cuestionario --- */
    .survey-header {
        text-align: center;
        margin-bottom: 40px;
    }
    
    .survey-header h2 {
        font-family: 'Montserrat', sans-serif;
        font-weight: 700;
        color: var(--text-dark-blue-grey);
        font-size: clamp(1.8rem, 5vw, 2.5rem); /* Título responsivo */
        padding-bottom: 20px;
        border-bottom: 2px solid var(--oracle-red-accent);
        display: inline-block;
    }

    /* ============================================================
    NUEVO DISEÑO: Tarjeta Interactiva por Pregunta
    ============================================================
    */
    .question-card {
        background-color: var(--neutral-white);
        border: 1px solid var(--border-light-grey);
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.07);
        margin-bottom: 2.5rem;
        overflow: hidden;
        transition: box-shadow 0.3s ease;
    }
    .question-card:hover {
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
    }

    .question-text {
        font-family: 'Montserrat', sans-serif;
        font-weight: 600;
        color: var(--text-dark-blue-grey);
        background-color: var(--panel-right-bg);
        padding: 1rem 1.5rem;
        font-size: 1.2em;
        border-bottom: 1px solid var(--border-light-grey);
    }

    .card-content-wrapper {
        padding: 1.5rem;
    }

    /* Opciones de respuesta */
    .options-container .form-check {
        margin-bottom: 0.75rem;
    }
    .options-container .form-check-label {
        font-size: 1rem;
        color: var(--text-medium-grey);
        cursor: pointer;
    }
    .options-container .form-check-input {
        cursor: pointer;
        border-color: var(--border-light-grey);
        transition: background-color 0.2s, border-color 0.2s;
    }
    .options-container .form-check-input:checked {
        background-color: var(--oracle-red-accent);
        border-color: var(--oracle-red-accent);
    }
    .options-container .form-check-input:focus {
        box-shadow: 0 0 0 0.25rem rgba(168, 60, 60, 0.25);
    }
    
    /* Contenedor de la gráfica */
    .chart-container {
        padding-top: 1rem;
        border-top: 1px dashed var(--border-light-grey);
        margin-top: 1.5rem;
    }
    .chart-container canvas {
        max-height: 200px; /* Limita la altura de las gráficas */
    }
    /* ========================================================== */


    /* --- Botón de Finalizar --- */
    .finish-button-container {
        text-align: center;
        margin-top: 2rem;
    }
    .btn-primary-custom {
        background-color: var(--oracle-red-accent);
        color: var(--neutral-white);
        padding: 12px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 15px rgba(168, 60, 60, 0.3);
    }
    .btn-primary-custom:hover {
        background-color: var(--oracle-red-hover);
        transform: translateY(-3px);
        box-shadow: 0 7px 20px rgba(139, 47, 47, 0.4);
    }

    /* --- Página de Agradecimiento (Sin cambios) --- */
    .thank-you-container{padding:50px 20px;text-align:center}.thank-you-icon{width:80px;height:80px;margin:0 auto 25px auto;color:var(--success-text)}.thank-you-container h2{font-family:'Montserrat',sans-serif;font-weight:700;color:var(--text-dark-blue-grey);font-size:2.2em}.thank-you-container p{color:var(--text-medium-grey);font-size:1.1em;margin-bottom:30px}.btn-secondary-custom{background-color:var(--main-bg-light);color:var(--text-medium-grey);padding:10px 25px;border:1px solid var(--border-light-grey);border-radius:8px;font-weight:500;text-decoration:none;transition:background-color .3s ease,color .3s ease}.btn-secondary-custom:hover{background-color:var(--border-light-grey);color:var(--text-dark-blue-grey)}
</style>

<div class="survey-main-container">
    <div id="survey-content">
        <div class="survey-header">
            <h2 id="questionnaire-title">Cargando...</h2>
        </div>

        <div id="interactive-cards-container">
            </div>

        <div class="finish-button-container">
            <button id="finish-btn" class="btn-primary-custom mt-4 d-none">Finalizar Encuesta</button>
        </div>
    </div>
    
    <div id="thank-you-message" class="d-none">
        <div class="thank-you-container">
            <div class="thank-you-icon"><svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/></svg></div>
            <h2>¡Gracias por tus respuestas!</h2>
            <p>Tu participación ha sido registrada con éxito.</p>
            <a href="/" class="btn-secondary-custom">Volver al inicio</a>
        </div>
    </div>
</div>

<script>
// ==========================================================
// TODA LA LÓGICA DE JAVASCRIPT PERMANECE SIN CAMBIOS,
// SALVO LA PARTE QUE CONSTRUYE LA INTERFAZ.
// ==========================================================
document.addEventListener('DOMContentLoaded', function() {
    // --- Definiciones de variables (sin cambios) ---
    const accessCode = '{{ access_code }}';
    const titleEl = document.getElementById('questionnaire-title');
    const cardsContainer = document.getElementById('interactive-cards-container'); // Nuevo contenedor principal
    const finishBtn = document.getElementById('finish-btn');
    let chartInstances = {};
    let questionnaireData = null;
    let pendingWebSocketMessages = [];

    // --- Funciones de UI (sin cambios en su lógica interna) ---
    function createQuestionUI(question, parentElement) {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'options-container';
        let optionsHtml = '';
        question.options.forEach(option => {
            optionsHtml += `<div class="form-check"><input class="form-check-input option-input" type="radio" name="question-${question.id}" value="${option.id}" id="option-${option.id}"><label class="form-check-label" for="option-${option.id}">${option.text}</label></div>`;
        });
        questionDiv.innerHTML = optionsHtml;
        parentElement.appendChild(questionDiv); // Se añade al elemento padre proporcionado
    }

    function createChartUI(question, parentElement) {
        const chartDiv = document.createElement('div');
        chartDiv.className = 'chart-container';
        chartDiv.innerHTML = `<canvas id="chart-${question.id}"></canvas>`;
        parentElement.appendChild(chartDiv); // Se añade al elemento padre proporcionado
    }

    // --- Lógica de inicialización/actualización de gráficas (sin cambios) ---
    function initializeOrUpdateChart(question, stats) {
        if (typeof Chart==='undefined'){console.error("Chart.js no está cargado.");return;}
        const ctx=document.getElementById(`chart-${question.id}`);if(!ctx){console.error(`Canvas para chart-${question.id} no encontrado.`);return;}
        const ctx2d=ctx.getContext('2d');
        const labels=question.options.map(opt=>opt.text);
        const data=question.options.map(opt=>stats[opt.id]||0);
        if(chartInstances[question.id]){chartInstances[question.id].data.datasets[0].data=data;chartInstances[question.id].update();}
        else{chartInstances[question.id]=new Chart(ctx2d,{type:'bar',data:{labels:labels,datasets:[{label:'Votos',data:data,backgroundColor:'rgba(168, 60, 60, 0.6)',borderColor:'rgba(168, 60, 60, 1)',borderWidth:1}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,scales:{x:{beginAtZero:true,ticks:{stepSize:1,precision:0}}},plugins:{legend:{display:false}}}});}
    }

    // --- Lógica de WebSockets y Votación (sin cambios) ---
    const wsProtocol=window.location.protocol==='https:'?'wss:':'ws:';
    const socket=new WebSocket(`${wsProtocol}//${window.location.host}/ws/survey/${accessCode}/`);
    socket.onopen=function(event){if(questionnaireData){while(pendingWebSocketMessages.length>0){const msg=pendingWebSocketMessages.shift();processWebSocketMessage(msg);}}};
    function processWebSocketMessage(e){const data=JSON.parse(e.data);if(!questionnaireData){pendingWebSocketMessages.push(e);return;}if(data.type==='initial_stats'){for(const qId in data.stats){const question=questionnaireData.questions.find(q=>q.id==qId);if(question){initializeOrUpdateChart(question,data.stats[qId]);}}}else if(data.type==='stats_update'){const question=questionnaireData.questions.find(q=>q.id==data.question_id);if(question){initializeOrUpdateChart(question,data.stats);}}}
    socket.onmessage=processWebSocketMessage;
    socket.onerror=function(error){console.error("Error de WebSocket:",error);};
    socket.onclose=function(event){console.warn("WebSocket cerrado:",event.code,event.reason);};
    cardsContainer.addEventListener('change',function(event){if(event.target.classList.contains('option-input')){const optionId=event.target.value;const questionId=event.target.name.split('-')[1];if(socket.readyState===WebSocket.OPEN){socket.send(JSON.stringify({question_id:parseInt(questionId),option_id:parseInt(optionId)}));}}});
    finishBtn.addEventListener('click',function(){if(socket.readyState===WebSocket.OPEN||socket.readyState===WebSocket.CONNECTING){socket.close(1000,'Encuesta finalizada por el usuario.');}document.getElementById('survey-content').classList.add('d-none');document.getElementById('thank-you-message').classList.remove('d-none');});


    // --- Carga inicial de datos ---
    fetch(`/api/questionnaires/public/forms/${accessCode}/`)
        .then(res => {
            if (!res.ok) { throw new Error('Cuestionario no encontrado o código inválido.'); }
            return res.json();
        })
        .then(data => {
            questionnaireData = data;
            titleEl.textContent = data.title;
            cardsContainer.innerHTML = ''; 
            
            /* ============================================================
            CAMBIO LÓGICO CLAVE:
            - Iteramos sobre cada pregunta.
            - Por cada una, creamos una tarjeta contenedora (`question-card`).
            - Dentro de esa tarjeta, creamos los elementos para la
              pregunta (opciones) y la gráfica.
            - Esto asegura que cada pregunta quede agrupada con su gráfica.
            ============================================================
            */
            data.questions.forEach(question => {
                // 1. Crear la tarjeta principal
                const card = document.createElement('div');
                card.className = 'question-card';

                // 2. Crear el encabezado con el texto de la pregunta
                const cardHeader = document.createElement('div');
                cardHeader.className = 'question-text';
                cardHeader.textContent = question.text;
                card.appendChild(cardHeader);

                // 3. Crear el contenedor para el contenido (opciones y gráfica)
                const cardContent = document.createElement('div');
                cardContent.className = 'card-content-wrapper';
                
                // 4. Crear y añadir las opciones de la pregunta a este contenedor
                createQuestionUI(question, cardContent);
                
                // 5. Crear y añadir la gráfica a este contenedor
                createChartUI(question, cardContent);

                // 6. Añadir el contenedor de contenido a la tarjeta principal
                card.appendChild(cardContent);

                // 7. Añadir la tarjeta completa al contenedor general
                cardsContainer.appendChild(card);
            });
            
            finishBtn.classList.remove('d-none'); 
            
            // Procesar mensajes WebSocket pendientes
            while(pendingWebSocketMessages.length > 0) {
                const msg = pendingWebSocketMessages.shift();
                processWebSocketMessage(msg);
            }
        })
        .catch(error => {
            console.error("Error en la carga inicial:", error);
            titleEl.textContent = 'Error';
            cardsContainer.innerHTML = `<p class="text-danger text-center p-5">${error.message}</p>`;
        });
});
</script>
{% endblock %}