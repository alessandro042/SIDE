{% extends "base.html" %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block content %}
<style>
    /* Paleta de colores: Neutra con acentos inspirados en Oracle Red (copiada de base.html) */
    :root {
        --main-bg-light: #F8FAFD;
        --panel-left-bg: #FFFFFF;
        --panel-right-bg: #F4F7FB; /* Usado para fondos de secciones o tarjetas claras */
        --oracle-red-accent: #A83C3C;
        --oracle-red-hover: #8B2F2F;
        --oracle-red-alert: #D65A5A;

        --text-dark-blue-grey: #333F4F;
        --text-medium-grey: #6C7A89;
        
        --border-light-grey: #DDE2E7;
        --input-focus-border: #9BB8D3; /* Un azul suave para focus, para no sobrecargar con rojo */

        --neutral-white: #FFFFFF;
        --error-bg-light: #FCEDED;
        --warning-bg-light: #FFFBF0;
        --success-bg-light: #E9FBF3;
        --warning-text: #EBC65D;
        --success-text: #66BB6A;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--main-bg-light); /* Fondo consistente */
    }

    /* Contenedor principal de la página */
    .page-main-container {
        padding: 25px 20px; /* Consistente con el dashboard */
        max-width: 1200px;
        margin: 20px auto;
        background-color: var(--neutral-white);
        border-radius: 15px; /* Consistente con el dashboard */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); /* Consistente con el dashboard */
    }

    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px; /* Consistente */
        padding-bottom: 15px; /* Consistente */
        border-bottom: 1px solid var(--border-light-grey); /* Consistente */
    }

    .page-header h2 {
        font-family: 'Montserrat', sans-serif; /* Consistente con otros títulos */
        font-size: 1.8em;
        color: var(--text-dark-blue-grey);
        font-weight: 700; /* Más negrita para títulos */
        margin: 0;
    }

    /* Botón "Crear Nuevo Usuario" como un icono de más (circular) */
    .btn-create-custom {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background-color: var(--oracle-red-accent); /* Rojo de acento */
        color: var(--neutral-white);
        display: flex;
        justify-content: center;
        align-items: center;
        border: none;
        cursor: pointer;
        font-size: 1.8em;
        line-height: 1;
        text-decoration: none;
        box-shadow: 0 5px 12px rgba(var(--oracle-red-accent-rgb), 0.3); /* Sombra con acento */
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
    }

    .btn-create-custom:hover {
        background-color: var(--oracle-red-hover); /* Rojo más oscuro al pasar el mouse */
        transform: translateY(-3px) rotate(90deg);
        box-shadow: 0 8px 20px rgba(var(--oracle-red-hover-rgb), 0.5);
    }

    .btn-create-custom svg {
        width: 22px;
        height: 22px;
        fill: currentColor;
        transition: transform 0.2s ease;
    }

    .btn-create-custom:hover svg {
        transform: rotate(-90deg);
    }

    /* Estilos para la tabla */
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 10px; /* Espacio entre filas */
        background-color: var(--neutral-white);
        border-radius: 12px; /* Consistente con el dashboard */
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Sombra consistente */
    }

    .table-custom thead th {
        background-color: var(--panel-right-bg); /* Fondo gris muy claro consistente */
        color: var(--text-dark-blue-grey);
        font-weight: 600;
        padding: 10px 18px; /* Padding ajustado */
        text-align: left;
        border-bottom: 1px solid var(--border-light-grey); /* Separador sutil */
        font-size: 0.85em; /* Tamaño de fuente ajustado */
    }
    .table-custom thead th:first-child { border-top-left-radius: 12px; }
    .table-custom thead th:last-child { border-top-right-radius: 12px; }


    .table-custom tbody tr {
        background-color: var(--neutral-white);
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        border-bottom: 1px solid var(--border-light-grey); /* Separador entre filas del body */
    }
    .table-custom tbody tr:last-child {
        border-bottom: none;
    }

    .table-custom tbody tr:hover {
        background-color: var(--panel-right-bg); /* Fondo al hover sutil */
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .table-custom tbody td {
        padding: 10px 18px; /* Padding ajustado */
        vertical-align: middle;
        color: var(--text-medium-grey);
        font-size: 0.8em; /* Tamaño de fuente ajustado */
    }
    
    .table-custom tbody tr:first-child td {
        border-top: none;
    }
    .table-custom tbody tr:last-child td:first-child { border-bottom-left-radius: 12px; }
    .table-custom tbody tr:last-child td:last-child { border-bottom-right-radius: 12px; }


    /* Badges para los roles */
    .badge-custom {
        display: inline-block;
        padding: 0.35em 0.6em; /* Padding ajustado */
        border-radius: 4px; /* Bordes ligeramente menos redondeados */
        font-size: 0.65em; /* Tamaño de fuente ajustado */
        font-weight: 700;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle; /* Alineación para que no se vea desfasado */
        color: var(--neutral-white);
    }
    .badge-admin { background-color: var(--text-dark-blue-grey); } /* Gris azulado oscuro para Admin */
    .badge-super-admin { background-color: var(--oracle-red-accent); } /* Rojo de acento para Super Admin */


    /* Estilos para los botones de acción (Editar/Eliminar) en la tabla */
    .btn-action-group-table {
        display: flex;
        gap: 4px; /* Espacio más compacto */
    }
    .btn-icon-custom {
        width: 32px; /* Tamaño un poco más pequeño para la tabla */
        height: 32px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 6px;
        transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        text-decoration: none;
        padding: 0;
        border: none;
        background-color: transparent;
    }
    .btn-icon-custom svg {
        width: 15px; /* Tamaño del icono SVG ajustado */
        height: 15px;
        fill: currentColor;
    }
    /* Colores para los iconos de la tabla */
    .btn-icon-custom.edit-user {
        color: var(--text-medium-grey); /* Gris medio para editar */
    }
    .btn-icon-custom.edit-user:hover {
        color: var(--text-dark-blue-grey);
        background-color: rgba(51, 63, 79, 0.1);
    }
    .btn-icon-custom.delete-user {
        color: var(--oracle-red-alert); /* Rojo de alerta para eliminar */
    }
    .btn-icon-custom.delete-user:hover {
        color: var(--oracle-red-hover);
        background-color: rgba(214, 90, 90, 0.1);
    }


    /* Estilos del Modal (reutilizados y adaptados) */
    .modal-content-custom {
        border-radius: 12px; /* Consistente */
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); /* Consistente */
        padding: 15px; /* Consistente */
        background-color: var(--neutral-white);
    }
    .modal-header-custom {
        border-bottom: none;
        padding-bottom: 0;
        font-family: 'Montserrat', sans-serif; /* Título del modal con fuente Oracle */
    }
    .modal-title-custom {
        font-weight: 600;
        color: var(--text-dark-blue-grey);
        font-size: 1.2em; /* Título del modal ajustado */
    }
    .modal-body-custom .form-label {
        font-weight: 600 !important;
        color: var(--text-dark-blue-grey);
        margin-bottom: 8px;
        font-size: 0.85em; /* Tamaño de fuente de las etiquetas del modal ajustado */
    }
    .modal-body-custom .form-control,
    .modal-body-custom .form-select {
        border-radius: 8px;
        padding: 8px 12px;
        border: 1px solid var(--border-light-grey);
        font-size: 0.85em; /* Tamaño de fuente de inputs/selects del modal ajustado */
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        background-color: var(--neutral-white);
    }
    .modal-body-custom .form-control:focus,
    .modal-body-custom .form-select:focus {
        border-color: var(--input-focus-border);
        box-shadow: 0 0 0 3px rgba(155, 184, 211, 0.2);
        outline: none;
    }
    .modal-footer-custom {
        border-top: none;
        padding-top: 15px;
        display: flex;
        justify-content: flex-end;
        gap: 10px; /* Espacio ajustado */
    }
    .modal-footer-custom .alert-danger-custom {
        margin-bottom: 0;
        flex-grow: 1;
        margin-right: 10px;
    }

    /* Botones del Modal */
    .btn-modal-secondary-custom { 
        background-color: var(--main-bg-light); /* Fondo con gris muy claro */
        color: var(--text-medium-grey); 
        padding: 8px 15px;
        border: 1px solid var(--border-light-grey);
        border-radius: 8px; /* Bordes redondeados */
        font-size: 0.85em; /* Tamaño de fuente ajustado */
        cursor: pointer; 
        transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease; 
        font-weight: 500; 
        text-decoration: none; 
    }
    .btn-modal-secondary-custom:hover {
        background-color: var(--border-light-grey);
        color: var(--text-dark-blue-grey);
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .btn-modal-primary-custom { 
        background-color: var(--oracle-red-accent); /* Rojo de acento */
        color: var(--neutral-white);
        padding: 8px 15px;
        border: none;
        border-radius: 8px; /* Bordes redondeados */
        font-size: 0.85em; /* Tamaño de fuente ajustado */
        cursor: pointer; 
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease; 
        font-weight: 600; 
    }
    .btn-modal-primary-custom:hover {
        background-color: var(--oracle-red-hover);
        transform: translateY(-1px);
        box-shadow: 0 3px 8px rgba(var(--oracle-red-hover-rgb), 0.3);
    }

    /* Mensaje de error (reutilizado y adaptado a paleta) */
    .alert-danger-custom { 
        background-color: var(--error-bg-light);
        color: var(--oracle-red-alert);
        border: 1px solid var(--oracle-red-alert);
        border-radius: 8px;
        padding: 10px; /* Ajustado */
        margin-bottom: 15px; /* Ajustado */
        font-size: 0.8em; /* Tamaño de fuente ajustado */
        text-align: center;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }
    .d-none {
        display: none !important;
    }

    /* Ocultar el small de la contraseña si no se requiere */
    #password-help-text.hidden {
        display: none !important;
    }

    /* ================================================= */
    /* ESTILOS PARA EL MODAL DE CONFIRMACIÓN (adaptado a paleta) */
    /* ================================================= */
    .confirmation-modal .modal-content {
        border-radius: 12px; /* Consistente */
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); /* Consistente */
        padding: 20px;
        text-align: center;
        background-color: var(--neutral-white);
    }

    .confirmation-modal .modal-header {
        border-bottom: none;
        padding-bottom: 0;
        display: flex;
        justify-content: center;
        position: relative;
        font-family: 'Montserrat', sans-serif; /* Consistente */
    }

    .confirmation-modal .modal-title {
        font-weight: 600;
        color: var(--oracle-red-alert); /* Título en rojo de alerta */
        font-size: 1.4em; /* Tamaño ajustado */
        margin: 0;
    }

    .confirmation-modal .modal-body {
        padding: 15px 0; /* Padding ajustado */
        font-size: 0.9em; /* Tamaño ajustado */
        color: var(--text-medium-grey);
    }
    .confirmation-modal .modal-body strong {
        color: var(--text-dark-blue-grey);
    }

    .confirmation-modal .modal-footer {
        border-top: none;
        padding-top: 10px;
        display: flex;
        justify-content: center;
        gap: 10px; /* Espacio ajustado */
    }

    /* Botón de cerrar (X) en el modal de confirmación */
    .confirmation-modal .btn-close {
        position: absolute;
        top: 10px; /* Ajustado */
        right: 10px; /* Ajustado */
        font-size: 1.1em; /* Ajustado */
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }
    .confirmation-modal .btn-close:hover {
        opacity: 1;
    }
    /* Estilo del icono de advertencia en el modal */
    .confirmation-icon {
        width: 50px; /* Tamaño ajustado */
        height: 50px;
        margin: 0 auto 15px auto; /* Margen ajustado */
        display: block;
    }
    .confirmation-icon svg {
        width: 100%;
        height: 100%;
        fill: var(--oracle-red-alert); /* Icono de advertencia en rojo de alerta */
    }

    /* Helper para RGBA, si no está en base.html */
    @supports (background-color: rgb(var(--text-dark-blue-grey-rgb))) {
        :root {
            --text-dark-blue-grey-rgb: 51, 63, 79;
            --text-medium-grey-rgb: 108, 122, 137;
            --oracle-red-accent-rgb: 168, 60, 60;
            --oracle-red-hover-rgb: 139, 47, 47; /* Añadida RGB para hover */
            --oracle-red-alert-rgb: 214, 90, 90;
        }
    }


    /* Media queries para responsividad */
    @media (max-width: 992px) {
        .page-main-container {
            padding: 20px 15px;
            margin: 15px auto;
        }
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }
        .page-header h2 {
            font-size: 1.6em;
            margin-bottom: 10px;
        }
        .btn-create-custom {
            width: 40px;
            height: 40px;
            font-size: 1.6em;
        }
        .btn-create-custom svg {
            width: 20px;
            height: 20px;
        }
        .table-custom thead th,
        .table-custom tbody td {
            padding: 10px 15px; /* Ajustado para móviles */
            font-size: 0.8em; /* Ajustado para móviles */
        }
        .badge-custom {
            font-size: 0.6em; /* Ajustado para móviles */
        }
        .btn-icon-custom {
            width: 28px; /* Ajustado para móviles */
            height: 28px;
        }
        .btn-icon-custom svg {
            width: 14px; /* Ajustado para móviles */
            height: 14px;
        }

        /* Modal en móviles */
        .modal-title-custom {
            font-size: 1.1em;
        }
        .modal-body-custom .form-label {
            font-size: 0.8em;
        }
        .modal-body-custom .form-control,
        .modal-body-custom .form-select {
            font-size: 0.8em;
        }
        .btn-modal-primary-custom,
        .btn-modal-secondary-custom {
            font-size: 0.8em;
            padding: 7px 12px;
        }
        .alert-danger-custom {
            font-size: 0.75em;
            padding: 8px;
        }
        .confirmation-modal .modal-title {
            font-size: 1.2em;
        }
        .confirmation-modal .modal-body {
            font-size: 0.8em;
        }
        .confirmation-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 10px auto;
        }
    }

</style>

<div class="page-main-container">
    <div class="page-header">
        <h2>Gestión de Usuarios</h2>
        <button id="create-user-btn" class="btn-create-custom" title="Crear un nuevo usuario">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>
        </button>
    </div>

    <div class="table-responsive">
        <table class="table-custom">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Username</th>
                    <th>Rol</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <tr><td colspan="5" class="text-center text-muted">Cargando usuarios...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="user-modal" tabindex="-1" aria-labelledby="modal-title" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"> 
        <div class="modal-content modal-content-custom">
            <div class="modal-header modal-header-custom">
                <h5 class="modal-title modal-title-custom" id="modal-title">Crear Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-custom">
                <form id="user-form">
                    <input type="hidden" id="user-id">
                    <div class="mb-3">
                        <label for="user-email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="user-email" required>
                    </div>
                    <div class="mb-3">
                        <label for="user-username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="user-username" required>
                    </div>
                    <div class="mb-3">
                        <label for="user-password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="user-password">
                        <small id="password-help-text" class="form-text text-muted hidden">Dejar en blanco para no cambiarla.</small> 
                    </div>
                    <div class="mb-3">
                        <label for="user-role" class="form-label">Rol</label>
                        <select class="form-select" id="user-role">
                            <option value="ADMIN">Admin</option>
                            <option value="SUPER_ADMIN">Super Admin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer-custom">
                <div id="form-error" class="alert-danger-custom d-none"></div> 
                <button type="button" class="btn-modal-secondary-custom" data-bs-dismiss="modal">Cancelar</button> 
                <button type="button" id="save-user-btn" class="btn-modal-primary-custom">Guardar</button> 
            </div>
        </div>
    </div>
</div>

<div class="modal fade confirmation-modal" id="confirm-delete-modal" tabindex="-1" aria-labelledby="confirm-delete-title" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm"> <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirm-delete-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <span class="confirmation-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M256 32c12.4 0 24.6 3.1 35.4 9L448 160V416c0 35.3-28.7 64-64 64H128c-35.3 0-64-28.7-64-64V160L220.6 41c10.8-5.9 23-9 35.4-9zM96 160V416c0 8.8 7.2 16 16 16H384c8.8 0 16-7.2 16-16V160H96zM272 256c0-8.8-7.2-16-16-16s-16 7.2-16 16v96c0 8.8 7.2 16 16 16s16-7.2 16-16V256zM256 128a32 32 0 1 0 0 64 32 32 0 1 0 0-64z"/></svg>
                </span>
                <p>¿Estás seguro de que quieres eliminar al usuario <strong><span id="confirm-username"></span></strong>?</p>
                <p class="text-danger small">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-modal-secondary-custom" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn-modal-primary-custom" id="confirm-delete-btn">Eliminar</button>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('authToken');
    const userTableBody = document.getElementById('user-table-body');
    const userModal = new bootstrap.Modal(document.getElementById('user-modal'));
    const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirm-delete-modal'));
    const userForm = document.getElementById('user-form');
    
    let userIdToDelete = null; 
    const confirmUsernameSpan = document.getElementById('confirm-username');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');


    if (!token) { window.location.href = '/login/'; return; }

    function fetchUsers() {
        fetch('/api/users/', { headers: { 'Authorization': `Token ${token}` }})
            .then(res => {
                if(res.status === 403) {
                    window.location.href = '/dashboard/';
                    alert('Acceso denegado. Solo los Super Admins pueden ver esta página.');
                    return;
                }
                return res.json();
            })
            .then(users => {
                if (!users) return;
                userTableBody.innerHTML = '';
                if (users.length === 0) {
                    userTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No hay usuarios registrados.</td></tr>';
                    return;
                }
                users.forEach(user => {
                    const row = `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.email}</td>
                            <td>${user.username}</td>
                            <td><span class="badge-custom badge-${user.role.toLowerCase().replace('_', '-')}" >${user.role}</span></td>
                            <td>
                                <div class="btn-action-group-table">
                                    <button class="btn-icon-custom edit-user" data-id="${user.id}" title="Editar Usuario">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M471.6 21.7c-21.9-21.9-57.5-21.9-79.4 0L331.3 82.5l98.9 98.9 60.9-60.9c21.9-21.9 21.9-57.5 0-79.4L471.6 21.7zm-299.7 206c-1.3 1.3-2.6 2.6-3.8 3.8L35.2 411.7c-4.6 4.6-6.6 11-6.6 17.7V464c0 10.1 8.2 18.2 18.2 18.2H96c6.7 0 13.1-2.1 17.7-6.6l180.2-180.2c1.3-1.3 2.6-2.6 3.8-3.8L171.9 227.7zM286.9 203c-6.1-6.1-16-6.1-22.1 0L35.2 411.7c-4.6 4.6-6.6 11-6.6 17.7V464c0 10.1 8.2 18.2 18.2 18.2H96c6.7 0 13.1-2.1 17.7-6.6l180.2-180.2c1.3-1.3 2.6-2.6 3.8-3.8L286.9 203z"/></svg>
                                    </button>
                                    <button class="btn-icon-custom delete-user" data-id="${user.id}" data-username="${user.username}" title="Eliminar Usuario">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M135.2 17.7C140.6 6.5 152 0 164.8 0H283.2c12.8 0 24.2 6.5 29.6 17.7L330.9 64H400c17.7 0 32 14.3 32 32s-14.3 32-32 32H48c-17.7 0-32-14.3-32-32s14.3-32 32-32h69.1L135.2 17.7zM248 248V408c0 8.8-7.2 16-16 16s-16-7.2-16-16V248c0-8.8 7.2-16 16-16s16 7.2 16 16zm-96 0V408c0 8.8-7.2 16-16 16s-16-7.2-16-16V248c0-8.8 7.2-16 16-16s16 7.2 16 16zm192 0V408c0 8.8-7.2 16-16 16s-16-7.2-16-16V248c0-8.8 7.2-16 16-16s16 7.2 16 16zM416 128H32v320c0 35.3 28.7 64 64 64H352c35.3 0 64-28.7 64-64V128z"/></svg>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    userTableBody.insertAdjacentHTML('beforeend', row);
                });
            })
            .catch(error => {
                console.error('Error al cargar usuarios:', error);
                if (error.status && error.status === 403) {
                    alert('Acceso denegado. Solo los Super Admins pueden ver esta página.');
                    window.location.href = '/dashboard/';
                } else if (error.message && error.message.includes('403')) {
                    alert('Acceso denegado. Solo los Super Admins pueden ver esta página.');
                    window.location.href = '/dashboard/';
                }
                else {
                    userTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar usuarios.</td></tr>';
                }
            });
    }

    document.getElementById('create-user-btn').addEventListener('click', () => {
        userForm.reset();
        document.getElementById('user-id').value = '';
        document.getElementById('modal-title').textContent = 'Crear Usuario';
        document.getElementById('password-help-text').classList.add('hidden');
        document.getElementById('user-password').required = true;
        document.getElementById('form-error').classList.add('d-none');
        userModal.show();
    });

    userTableBody.addEventListener('click', event => {
        const editButton = event.target.closest('.edit-user');
        if (editButton) {
            const userId = editButton.dataset.id;
            fetch(`/api/users/${userId}/`, { headers: { 'Authorization': `Token ${token}` }})
                .then(res => res.json())
                .then(user => {
                    userForm.reset();
                    document.getElementById('user-id').value = user.id;
                    document.getElementById('user-email').value = user.email;
                    document.getElementById('user-username').value = user.username;
                    document.getElementById('user-role').value = user.role;
                    document.getElementById('modal-title').textContent = 'Editar Usuario';
                    document.getElementById('password-help-text').classList.remove('hidden');
                    document.getElementById('user-password').required = false;
                    document.getElementById('form-error').classList.add('d-none');
                    userModal.show();
                })
                .catch(error => {
                    console.error('Error al cargar usuario para editar:', error);
                    alert('No se pudo cargar los datos del usuario para editar. Intente de nuevo.');
                });
        }

        const deleteButton = event.target.closest('.delete-user');
        if (deleteButton) {
            userIdToDelete = deleteButton.dataset.id;
            const usernameToDelete = deleteButton.dataset.username;
            confirmUsernameSpan.textContent = usernameToDelete;
            confirmDeleteModal.show();
        }
    });

    confirmDeleteBtn.addEventListener('click', () => {
        if (userIdToDelete) {
            fetch(`/api/users/${userIdToDelete}/`, {
                method: 'DELETE',
                headers: { 'Authorization': `Token ${token}` }
            })
            .then(response => {
                if (response.ok) {
                    confirmDeleteModal.hide();
                    fetchUsers();
                } else {
                    return response.json().then(errorData => {
                        confirmDeleteModal.hide();
                        alert(errorData.detail || `No se pudo eliminar al usuario con ID ${userIdToDelete}.`);
                    });
                }
            })
            .catch(error => {
                console.error('Error al eliminar usuario:', error);
                confirmDeleteModal.hide();
                alert('Ocurrió un error de red al intentar eliminar el usuario.');
            });
        }
    });

    document.getElementById('save-user-btn').addEventListener('click', () => {
        const userId = document.getElementById('user-id').value;
        const url = userId ? `/api/users/${userId}/` : '/api/users/';
        const method = userId ? 'PATCH' : 'POST';

        const payload = {
            email: document.getElementById('user-email').value,
            username: document.getElementById('user-username').value,
            role: document.getElementById('user-role').value,
        };
        const passwordInput = document.getElementById('user-password');
        if (passwordInput.value) {
            payload.password = passwordInput.value;
        }

        const formErrorDiv = document.getElementById('form-error');
        formErrorDiv.classList.add('d-none');

        if (!payload.email || !payload.username || (method === 'POST' && !payload.password)) {
            formErrorDiv.textContent = 'Por favor, rellena todos los campos obligatorios (Email, Username y Contraseña para nuevos usuarios).';
            formErrorDiv.classList.remove('d-none');
            return;
        }

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json', 'Authorization': `Token ${token}`},
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(errorData => { 
                    throw errorData; 
                });
            }
            return res.json();
        })
        .then(() => {
            userModal.hide();
            fetchUsers();
        })
        .catch(err => {
            console.error('Error al guardar usuario:', err);
            let errorMessageText = 'Ocurrió un error al guardar. Verifique los datos.';
            if (err.email) errorMessageText = `Email: ${err.email.join(', ')}`;
            else if (err.username) errorMessageText = `Username: ${err.username.join(', ')}`;
            else if (err.password) errorMessageText = `Contraseña: ${err.password.join(', ')}`;
            else if (err.detail) errorMessageText = err.detail;
            
            formErrorDiv.textContent = errorMessageText;
            formErrorDiv.classList.remove('d-none');
        });
    });

    fetchUsers();
});
</script>
{% endblock %}